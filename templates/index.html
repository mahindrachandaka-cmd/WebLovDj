<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mahi Dev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        
        /* Gradient Background */
        .bg-custom-gradient {
            background: linear-gradient(180deg, #ffffff 0%, #fce7f3 40%, #d946ef 60%, #84cc16 100%);
        }
        
        /* Glass Effect */
        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            box-shadow: 0 -4px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
        }

        /* Message Bubbles */
        .msg-user {
            background: #d946ef; /* Pink */
            color: white;
            border-radius: 18px 18px 4px 18px;
            align-self: flex-end;
            box-shadow: 0 2px 5px rgba(217, 70, 239, 0.3);
        }
        .msg-ai {
            background: #ffffff;
            color: #374151;
            border-radius: 18px 18px 18px 4px;
            align-self: flex-start;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #f3f4f6;
        }

        /* Animations */
        .fade-out { opacity: 0; pointer-events: none; transition: opacity 0.8s ease; }
        .hidden-screen { display: none; }
        .active-screen { display: flex; }
        
        /* Title Style */
        .title-outline {
            color: #ecfccb; 
            -webkit-text-stroke: 1px #84cc16;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-gray-50 text-gray-800">

    <!-- SCREEN 1: SPLASH SCREEN -->
    <div id="splash" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white transition-opacity duration-1000">
        <h1 class="text-6xl font-extrabold title-outline tracking-wider animate-pulse">Mahi Dev</h1>
    </div>

    <!-- SCREEN 2: HOME INPUT -->
    <div id="home-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-custom-gradient hidden-screen">
        <div class="absolute top-20">
            <h1 class="text-5xl font-extrabold title-outline tracking-wider">Mahi Dev</h1>
        </div>

        <div class="w-full px-6 flex flex-col items-center gap-6 z-10">
            <h2 class="text-3xl font-bold text-lime-700 drop-shadow-sm">Ready to build?</h2>
            
            <!-- Main Input Box -->
            <div class="bg-white/90 backdrop-blur-md w-full p-2 pl-5 pr-2 rounded-[2rem] shadow-xl flex items-center gap-2 border border-white/50">
                <input id="prompt-input" type="text" placeholder="ask to build your dream app" 
                    class="flex-1 bg-transparent text-gray-700 text-lg outline-none placeholder-gray-400 py-4">
                
                <button onclick="startBuilding()" class="bg-black hover:bg-gray-800 text-white rounded-full w-12 h-12 flex items-center justify-center transition shadow-lg transform active:scale-95">
                    <i class="fas fa-arrow-up text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- SCREEN 3: WORKSPACE (Chat & Preview) -->
    <div id="workspace-screen" class="fixed inset-0 flex flex-col bg-gray-50 hidden-screen">
        
        <!-- Header -->
        <div class="h-16 flex items-center px-4 bg-white border-b border-gray-100 justify-between shrink-0 z-20">
            <div class="flex items-center">
                <button onclick="goHome()" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-chevron-left text-lg"></i></button>
                <h3 class="ml-4 font-bold text-gray-800 tracking-tight">Mahi Builder</h3>
            </div>
            <div class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-medium flex items-center gap-1">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Online
            </div>
        </div>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 relative overflow-hidden flex flex-col">
            
            <!-- 1. CHAT VIEW -->
            <div id="chat-view" class="absolute inset-0 flex flex-col z-10 bg-gray-50/50">
                <!-- Messages List -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 pb-40 flex flex-col gap-4 no-scrollbar">
                    <!-- Intro Message -->
                    <div class="msg-ai p-4 max-w-[85%] text-sm shadow-sm">
                        Hello! I am Mahi Dev. Describe your app, and I will build it for you instantly. ðŸš€
                    </div>
                </div>

                <!-- Chat Input Area (Floating above nav) -->
                <div class="absolute bottom-24 left-0 right-0 px-4 z-20">
                    <div class="glass-input rounded-[2rem] p-2 pl-4 pr-2 flex items-center gap-2">
                        <input id="chat-input" type="text" placeholder="Type a new change (e.g., 'Make background blue')..." 
                            class="flex-1 bg-transparent text-sm outline-none text-gray-700 py-3">
                        <button onclick="sendChatMessage()" class="bg-lime-500 hover:bg-lime-600 text-white rounded-full w-10 h-10 flex items-center justify-center transition shadow-md">
                            <i class="fas fa-arrow-up text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. PREVIEW VIEW (Iframe) -->
            <iframe id="preview-frame" class="absolute inset-0 w-full h-full bg-white hidden z-10"></iframe>
            
            <!-- Loader Overlay -->
            <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm z-30 hidden">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-lime-500"></div>
                <p class="mt-4 text-gray-600 font-medium text-sm animate-pulse">Generating Code...</p>
            </div>
        </div>

        <!-- BOTTOM NAVIGATION BAR -->
        <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 w-[95%] max-w-md z-50">
            <div class="glass-nav rounded-full p-2 flex items-center justify-between px-4">
                <!-- Logo -->
                <div class="bg-gradient-to-br from-pink-500 to-orange-400 w-8 h-8 rounded-full text-white flex items-center justify-center font-bold text-xs shadow-md">M</div>
                
                <!-- Toggle Switch -->
                <div class="bg-gray-100/80 rounded-full p-1 flex border border-gray-200">
                    <button onclick="switchTab('chat')" id="btn-chat" class="px-5 py-2 rounded-full text-xs font-bold bg-white shadow-sm text-gray-900 transition-all">Chat</button>
                    <button onclick="switchTab('preview')" id="btn-preview" class="px-5 py-2 rounded-full text-xs font-bold text-gray-500 hover:text-gray-700 transition-all">Preview</button>
                </div>

                <!-- Menu -->
                <div class="relative">
                    <button onclick="toggleMenu()" class="w-9 h-9 flex items-center justify-center hover:bg-gray-100 rounded-full text-gray-600 transition">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    
                    <!-- Dropdown -->
                    <div id="menu-dropdown" class="absolute bottom-14 right-0 w-56 bg-white rounded-2xl shadow-xl p-2 hidden flex-col gap-1 border border-gray-100 animate-[fadeIn_0.2s_ease-out]">
                        <button onclick="viewCode()" class="flex items-center gap-3 w-full text-left px-4 py-3 rounded-xl hover:bg-gray-50 text-sm text-gray-700">
                            <i class="fas fa-code text-pink-500"></i> View Source Code
                        </button>
                        <button onclick="downloadZip()" class="flex items-center gap-3 w-full text-left px-4 py-3 rounded-xl hover:bg-gray-50 text-sm text-gray-700">
                            <i class="fas fa-file-export text-lime-500"></i> Export as ZIP
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Code View Modal -->
    <div id="code-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex flex-col p-4 backdrop-blur-sm">
        <div class="flex justify-between items-center mb-4 text-white">
            <h2 class="font-bold text-lg">Source Code</h2>
            <button onclick="document.getElementById('code-modal').classList.add('hidden')" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-full text-xs transition">Close</button>
        </div>
        <textarea id="code-area" class="flex-1 bg-gray-900 text-green-400 font-mono text-xs p-4 rounded-xl outline-none border border-gray-800" readonly></textarea>
    </div>

    <script>
        let currentCode = "";
        
        // --- Splash Screen ---
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('splash').style.display = 'none';
                    document.getElementById('home-screen').classList.remove('hidden-screen');
                    document.getElementById('home-screen').classList.add('active-screen');
                }, 800);
            }, 2000);
        };

        // --- Core Functions ---

        async function startBuilding() {
            const input = document.getElementById('prompt-input');
            const prompt = input.value.trim();
            if (!prompt) return;

            // UI Transition
            document.getElementById('home-screen').classList.remove('active-screen');
            document.getElementById('home-screen').classList.add('hidden-screen');
            document.getElementById('workspace-screen').classList.remove('hidden-screen');
            document.getElementById('workspace-screen').classList.add('active-screen');

            // Add User Message to Chat
            addMessage(prompt, 'user');
            
            // Call AI
            await generateCode(prompt);
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const prompt = input.value.trim();
            if (!prompt) return;

            addMessage(prompt, 'user');
            input.value = ""; // Clear input
            
            // Contextual Prompt
            let fullPrompt = "";
            if (currentCode) {
                fullPrompt = `Here is my current HTML code: ${currentCode}. \n\n User Request: ${prompt}. \n\n Update the code accordingly and return the FULL updated HTML file only.`;
            } else {
                fullPrompt = prompt;
            }

            await generateCode(fullPrompt);
        }

        async function generateCode(prompt) {
            document.getElementById('loader').classList.remove('hidden');
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });
                const data = await response.json();
                
                if (data.code) {
                    currentCode = data.code;
                    document.getElementById('preview-frame').srcdoc = currentCode;
                    document.getElementById('code-area').value = currentCode;
                    
                    // Add AI Success Message
                    addMessage("I've updated the app! Check the Preview tab.", 'ai');
                    
                    // Auto switch to preview for first time, else stay on chat
                    if (document.getElementById('messages-container').children.length <= 2) {
                        switchTab('preview');
                    }
                } else {
                    addMessage("Sorry, I couldn't generate the code. Try again.", 'ai');
                }
            } catch (err) {
                addMessage("Server error. Please check your connection.", 'ai');
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        // --- UI Helpers ---

        function addMessage(text, sender) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            div.className = sender === 'user' ? 'msg-user p-3 px-5 max-w-[85%] text-sm shadow-sm' : 'msg-ai p-4 max-w-[85%] text-sm shadow-sm';
            div.innerText = text;
            container.appendChild(div);
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function switchTab(tab) {
            const btnChat = document.getElementById('btn-chat');
            const btnPreview = document.getElementById('btn-preview');
            const chatView = document.getElementById('chat-view');
            const previewFrame = document.getElementById('preview-frame');

            if (tab === 'chat') {
                btnChat.className = "px-5 py-2 rounded-full text-xs font-bold bg-white shadow-sm text-gray-900 transition-all";
                btnPreview.className = "px-5 py-2 rounded-full text-xs font-bold text-gray-500 hover:text-gray-700 transition-all";
                chatView.classList.remove('hidden');
                previewFrame.classList.add('hidden');
            } else {
                btnPreview.className = "px-5 py-2 rounded-full text-xs font-bold bg-white shadow-sm text-gray-900 transition-all";
                btnChat.className = "px-5 py-2 rounded-full text-xs font-bold text-gray-500 hover:text-gray-700 transition-all";
                chatView.classList.add('hidden');
                previewFrame.classList.remove('hidden');
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('menu-dropdown');
            menu.classList.toggle('hidden');
            menu.classList.toggle('flex');
        }

        function viewCode() {
            document.getElementById('code-modal').classList.remove('hidden');
            toggleMenu();
        }

        function goHome() {
            if(confirm("Start a new project? Current progress will be lost.")) {
                location.reload();
            }
        }

        async function downloadZip() {
            if (!currentCode) return alert("Nothing to download yet!");
            const response = await fetch('/download-zip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: currentCode })
            });
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "MahiDev_Project.zip";
            a.click();
            toggleMenu();
        }

        // Enter key to send
        document.getElementById('prompt-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') startBuilding();
        });
        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendChatMessage();
        });

    </script>
</body>
  </html>
